# Архитектура

## Обзор

Приложение визуализирует электростатическое поле от набора точечных зарядов:
- Основной проход — полноэкранный прямоугольник (fullscreen quad).
- Фрагментный шейдер суммирует вклад всех зарядов для каждого пикселя: вычисляет потенциал и преобразует его в цвет.
- Линии напряженности и эквипотенциалы накладываются (концептуально) как дополнительные графические слои.

## Слои

1. UI слой:
   - Выбор/редактирование зарядов.
   - Переключатели видимости (заряды / линии / эквипотенциалы).
2. Логический слой:
   - Массив зарядов + операции CRUD.
   - Генерация seed-точек для силовых линий.
3. GPU слой:
   - Буферы вершин fullscreen quad.
   - Uniform / texture для списка зарядов (в текущей версии — возможно прямые uniform-передачи).
   - Шейдерные программы.
4. Визуализация:
   - Потенциал → цветовая карта.
   - Линии напряженности (отрисовка line-strip или динамических вершин) — CPU или GPU генерация.
   - Эквипотенциалы — шейдерный контурный порог или предварительный marching squares.

## Поток данных

UI → обновление массива `map.mQ` → (перезапись GPU униформ/ресурса) → шейдерный проход → визуализация кадра.

## Расширяемость к WebGPU

### Целевые изменения
- Выделение адаптера/устройства (`navigator.gpu.requestAdapter()`).
- Storage buffer для массива зарядов.
- Compute pass: заполнение 2D-текстуры потенциала.
- Render pass: выборка текстуры и преобразование в цвет.
- Отдельный compute pass для трассировки силовых линий (итеративное интегрирование).

## Форматы данных

| Сущность | Формат | Примечание |
|----------|--------|------------|
| Charge | vec4(x, y, q, aux) | aux резерв |
| Seed линии | vec2 | Начальная позиция |
| Поле потенциала | float (R32F) | (В WebGL1 имитация через RGBA8/log) |

## Ошибки и устойчивость

- Деление на ноль избегается добавлением ε² в расстояние.
- Суммы при больших q могут переполнять цвет — используется компрессия (см. алгоритмы).
- Производительность: O(Nₚикселей * Nзарядов).

---